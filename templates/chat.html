{% extends "base.html" %}

{% block title %}–ß–∞—Ç - Discock{% endblock %}

{% block head %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endblock %}

{% block content %}
<div class="chat-layout">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–æ–º–Ω–∞—Ç–∞–º–∏ -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Discock</h2>
            <div class="user-info">
                <span class="username">{{ current_user.username }}</span>
                <span class="user-city">üìç {{ current_user.city }}</span>
            </div>
            <a href="{{ url_for('logout') }}" class="logout-btn">–í—ã–π—Ç–∏</a>
        </div>
        
        <div class="rooms-section">
            <div class="rooms-header">
                <h3>–ö–æ–º–Ω–∞—Ç—ã</h3>
                <button id="create-room-btn" class="btn-icon" title="–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É">+</button>
            </div>
            <ul class="rooms-list" id="rooms-list">
                {% for room in rooms %}
                <li class="room-item {% if current_room and room.id == current_room.id %}active{% endif %}">
                    <a href="{{ url_for('chat', room=room.id) }}" data-room-id="{{ room.id }}">
                        <span class="room-icon">#</span>
                        <span class="room-name">{{ room.name }}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç–µ -->
        {% if current_room %}
        <div class="users-section" id="users-section">
            <div class="users-header">
                <h3>–í –∫–æ–º–Ω–∞—Ç–µ</h3>
                <span class="users-count" id="users-count">0</span>
            </div>
            <ul class="users-list" id="users-list">
                <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </ul>
        </div>
        {% endif %}
    </aside>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <main class="chat-main">
        {% if current_room %}
        <div class="chat-header">
            <div class="chat-header-top">
                <div>
                    <h2># {{ current_room.name }}</h2>
                    {% if current_room.description %}
                    <p class="room-description">{{ current_room.description }}</p>
                    {% endif %}
                </div>
                <div class="voice-controls">
                    <button id="mic-toggle" class="voice-btn btn-danger" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω" onclick="toggleMicrophone()">
                        <span id="mic-icon">üé§</span>
                        <span id="mic-status">–í—ã–∫–ª—é—á–µ–Ω</span>
                    </button>
                    
                    <button id="toggle-speaker-btn" class="voice-btn active" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –¥–∏–Ω–∞–º–∏–∫–∏" onclick="toggleSpeaker()">
                        <span id="speaker-icon">üîä</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="messages-container" id="messages-container">
            {% for message in messages %}
            <div class="message" data-message-id="{{ message.id }}">
                <div class="message-header">
                    <span class="message-author">{{ message.user.username }}</span>
                    <span class="message-city">üìç {{ message.user.city }}</span>
                    <span class="message-time">{{ message.timestamp.strftime('%H:%M') }}</span>
                </div>
                <div class="message-content">{{ message.content }}</div>
            </div>
            {% endfor %}
        </div>
        
        <div class="message-input-container">
            <form id="message-form" class="message-form">
                <input 
                    type="text" 
                    id="message-input" 
                    class="message-input" 
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    autocomplete="off"
                >
                <button type="submit" class="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
        {% else %}
        <div class="no-room-selected">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
        </div>
        {% endif %}
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã -->
<div id="create-room-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h3>
            <button class="modal-close" id="close-modal">&times;</button>
        </div>
        <form id="create-room-form" class="modal-form">
            <div class="form-group">
                <label for="room-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</label>
                <input type="text" id="room-name" class="form-input" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="form-group">
                <label for="room-description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="room-description" class="form-input" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancel-create-room">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const CURRENT_ROOM_ID = {% if current_room %}{{ current_room.id }}{% else %}null{% endif %};
    const CURRENT_USER = {
        id: {{ current_user.id }},
        username: "{{ current_user.username }}",
        city: "{{ current_user.city }}"
    };
</script>
<script src="{{ url_for('static', filename='js/voice-chat.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}
